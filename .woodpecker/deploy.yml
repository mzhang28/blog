steps:
  build:
    image: git.mzhang.io/michael/blog-docker-builder:a77ri0sj9k628rhrx0iz3zx93wddc70z
    environment:
      - ASTRO_TELEMETRY_DISABLED=1
    commands:
      - mkdir /tmp
      - rm -rf node_modules
      - bun install --frozen-lockfile
      - bun pm trust --all
      - bun run build
    when:
      - event: push

  deploy:
    image: git.mzhang.io/michael/blog-docker-builder:a77ri0sj9k628rhrx0iz3zx93wddc70z
    commands:
      - mc alias set $AWS_DEFAULT_REGION $AWS_ENDPOINT_URL $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY --api S3v4
      - mc mirror --overwrite ./dist/ $AWS_DEFAULT_REGION/mzhang-io-website/
    secrets:
      - AWS_ACCESS_KEY_ID
      - AWS_DEFAULT_REGION
      - AWS_ENDPOINT_URL
      - AWS_SECRET_ACCESS_KEY
    when:
      - branch: master
        event: push
